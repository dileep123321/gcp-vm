name: CI/CD FastAPI â†’ GCP VM (OIDC)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

env:
  IMAGE_NAME: fastapi
  IMAGE_TAG: latest
  REGION: us-central1
  ZONE: us-central1-a
  ARTIFACT_REPO: gcp-vm
  IMAGE_HOST: us-central1-docker.pkg.dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Docker auth
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & Push Image
        run: |
          PROJECT=${{ secrets.GCP_PROJECT_ID }}
          FULL_IMAGE="${IMAGE_HOST}/${PROJECT}/${ARTIFACT_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV
          docker build -t "$FULL_IMAGE" -f docker/Dockerfile .
          docker push "$FULL_IMAGE"

      - name: Generate ephemeral SSH key
        run: |
          KEY_DIR=$(mktemp -d)
          ssh-keygen -t ed25519 -f "$KEY_DIR/id_ed25519" -N ""
          echo "SSH_KEY_DIR=$KEY_DIR" >> $GITHUB_ENV
          PUB_KEY=$(cat "$KEY_DIR/id_ed25519.pub")
          echo "SSH_PUB=$PUB_KEY" >> $GITHUB_ENV

      - name: Terraform Apply
        working-directory: infra/terraform
        run: |
          terraform init -input=false
          terraform apply -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="container_image=${{ env.FULL_IMAGE }}" \
            -var="ssh_user=github" \
            -var="ssh_public_key=${{ env.SSH_PUB }}"

      - name: Get VM IP
        id: getip
        working-directory: infra/terraform
        run: |
          VM_IP=$(terraform output -raw vm_ip)
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV

      - name: Deploy container via SSH
        run: |
          KEY="${{ env.SSH_KEY_DIR }}/id_ed25519"
          chmod 600 "$KEY"
          ssh -o StrictHostKeyChecking=no -i "$KEY" github@${{ env.VM_IP }} \
            "sudo docker pull ${{ env.FULL_IMAGE }} && \
             sudo docker rm -f fastapi-app || true && \
             sudo docker run -d --restart unless-stopped -p 8000:8000 --name fastapi-app ${{ env.FULL_IMAGE }}"
