name: Build and Deploy to GCP VM

on:
  push:
    branches:
      - main

# IMPORTANT â€” REQUIRED FOR OIDC LOGIN
permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: kxnwork
  REGION: us-central1
  IMAGE_NAME: fastapi
  IMAGE_TAG: latest
  ARTIFACT_REPO: gcp-vm
  IMAGE_HOST: us-central1-docker.pkg.dev
  VM_NAME: fastapi-vm
  VM_ZONE: us-central1-a

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------
      # CHECKOUT CODE
      # ------------------
      - name: Checkout
        uses: actions/checkout@v3

      # ------------------
      # AUTH USING OIDC
      # ------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/382207431122/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "gh-ci-sa@kxnwork.iam.gserviceaccount.com"

      # ------------------
      # INSTALL CLOUD SDK
      # ------------------
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # ------------------
      # CONFIGURE DOCKER LOGIN
      # ------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $IMAGE_HOST --quiet

      # ------------------
      # DOCKER BUILD & PUSH
      # ------------------
      - name: Build & Push Docker Image
        run: |
          IMAGE_URI="$IMAGE_HOST/$PROJECT_ID/$ARTIFACT_REPO/$IMAGE_NAME:$IMAGE_TAG"
          echo "IMAGE_URI=$IMAGE_URI"

          docker build -t $IMAGE_URI ./app
          docker push $IMAGE_URI

      # ------------------
      # DEPLOY TO VM
      # ------------------
      - name: Deploy to VM
        run: |
          IMAGE_URI="$IMAGE_HOST/$PROJECT_ID/$ARTIFACT_REPO/$IMAGE_NAME:$IMAGE_TAG"

          gcloud compute ssh $VM_NAME --zone=$VM_ZONE --command "
            sudo docker pull $IMAGE_URI &&
            sudo docker stop fastapi || true &&
            sudo docker rm fastapi || true &&
            sudo docker run -d --name fastapi -p 80:80 $IMAGE_URI
          "

